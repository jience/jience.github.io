# 服务监控

> 通过`exporter`采集各服务的监控数据，并推送到`prometheus`\
> 根据各服务设置的告警规则，`prometheus`通过`alertmanager`实现告警信息推送\
> 同时可通过`grafana`实现可视化

### 预研环境
 1. http://178.103.224.86:3000/dashboards admin/amin
 2. http://178.103.224.86:9090

### 相关镜像
  1. prom/prometheus:v2.43.0 
  2. prom/alertmanager:v0.25.0
  3. grafana/grafana:9.4.7
  4. oliver006/redis_exporter:v1.49.0
  5. prom/mysqld-exporter:v0.14.0
  6. quay.io/prometheus/node-exporter:v1.5.0
  7. gcr.nju.edu.cn/cadvisor/cadvisor:v0.47.1

### 目录

```
.
├── docker-compose.yml              // docker-compose部署服务
├── conf                            // 配置文件目录
│   │── prometheus                  // prometheus配置文件目录
│   │   │── prometheus.yml          // prometheus主配置文件
│   │   │── rules                   // 告警规则文件目录
│   │   │   │── docker.yaml         // 容器告警规则
│   │   │   │── etcd.yaml           // etcd服务告警规则
│   │   │   │── mysql.yaml          // mysql服务告警规则
│   │   │   │── node.yaml           // node告警规则
│   │   │   │── prometheus.yaml     // prometheus服务告警规则
│   │   │   └── redis.yaml          // redis服务告警规则
│   └── alertmanager                // alertmanager配置文件目录                  
│       │── alertmanager.yml        // alertmanager主配置文件
│       └── tmpl                    // 消息模板文件目录
│           └── e-mail.tmpl         // 消息模板文件
├── data
│   ├── grafana                     // grafana数据目录
│   └── prometheus                  // prometheus数据目录
```

### 服务部署

> prometheus + alertmanager + grafana

```yaml
version: "2.4"
services:
  prometheus:
    image: prom/prometheus:v2.43.0
    container_name: prometheus
    network_mode: "host"
    #    ports:
    #      - "9090:9090"
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --web.enable-lifecycle
      - --storage.tsdb.retention=30d
    volumes:
      - ./conf/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - ./conf/prometheus/rules:/etc/prometheus/rules
      - ./data/prometheus:/prometheus
    restart: always
    environment:
      TZ:  Asia/Shanghai

  alertmanager:
    image: prom/alertmanager:v0.25.0
    container_name: alertmanager
    network_mode: "host"
    #    ports:
    #      - "9093:9093"
    volumes:
      - ./conf/alertmanager/conf:/etc/alertmanager
    restart: always
    networks:
      - default
    environment:
      TZ:  Asia/Shanghai

  grafana:
    image: grafana/grafana:9.4.7
    container_name: grafana
    network_mode: "host"
    #    ports:
    #      - "3000:3000"
    volumes:
      - ./data/grafana:/var/lib/grafana
    restart: always
    environment:
      TZ:  Asia/Shanghai
```

### exporter部署

> redis-exporter + mysqld-exporter + node-exporter + cadvisor(docker-exporter) \
> etcd无需部署exporter，自带/metrics


```yaml
version: "2.4"
services:
  redis-exporter:
    image: oliver006/redis_exporter:v1.49.0
    container_name: redis_exporter
    network_mode: "host"
    #    ports:
    #      - "9121:9121"
    restart: always
    environment:
      TZ:  Asia/Shanghai
      REDIS_ADDR: "redis://redis:6379"
      REDIS_PASSWORD: ""

  mysqld-exporter:
    image: prom/mysqld-exporter:v0.14.0
    container_name: mysqld_exporter
    network_mode: "host"
    #    ports:
    #      - "9104:9104"
    restart: always
    environment:
      DATA_SOURCE_NAME: root:${MYSQL_ROOT_PASSWORD}@(mysql:3306)/
      TZ:  Asia/Shanghai

  node-exporter:
    image: quay.io/prometheus/node-exporter:v1.5.0
    container_name: node-exporter
    network_mode: "host"
    command:
      - '--path.rootfs=/host'
    #    ports:
    #      - "9100:9100"
    restart: always
    volumes:
      - '/:/host:ro,rslave'
    environment:
      TZ:  Asia/Shanghai

  cadvisor:
    image: gcr.nju.edu.cn/cadvisor/cadvisor:v0.47.1
    container_name: cadvisor
    network_mode: "host"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:rw
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    devices:
      - /dev/kmsg:/dev/kmsg
    #    ports:
    #      - "8080:8080"
    restart: always
    environment:
      TZ:  Asia/Shanghai
```

### 配置文件

#### Prometheus配置文件

```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - 127.0.0.1:9093
            
# 加载告警规则文件
rule_files:
  - "rules/*.yaml"

# targets为exporter实际地址
# labels.instance为告警模板中显示的实例名或主机名
scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets:
          - 127.0.0.1:9090
        labels:
          instance: 178.103.224.86
          job: prometheus
          server: prometheus

  - job_name: 'alertmanager'
    static_configs:
      - targets:
          - 127.0.0.1:9093
        labels:
          instance: 178.103.224.86
          job: alertmanager
          server: alertmanager

  - job_name: 'grafana'
    static_configs:
      - targets:
          - 127.0.0.1:3000
        labels:
          instance: 178.103.224.86
          job: grafana
          server: grafana

  # suggest grafana dashboard ID: 11074
  - job_name: 'nodes'
    static_configs:
      - targets:
          - 127.0.0.1:9100
        labels:
          instance: 178.103.224.86
          job: node
          server: node

  # suggest grafana dashboard ID: 7362
  - job_name: 'mysqld'
    static_configs:
      - targets:
          - 127.0.0.1:9104
        labels:
          instance: 178.103.224.86
          job: mysqld
          server: mysql

  # suggest grafana dashboard ID: 11835
  - job_name: 'redis'
    static_configs:
      - targets:
          - 127.0.0.1:9121
        labels:
          instance: 178.103.224.86
          job: redis
          server: redis
          cluster: redis

  # suggest grafana dashboard ID: 3070
  - job_name: 'etcd'
    metrics_path: '/metrics'
    static_configs:
      - targets:
          - 127.0.0.1:2379
        labels:
          instance: 178.103.224.86
          job: etcd
          server: etcd

  # suggest grafana dashboard ID: 11600
  - job_name: 'cadvisor'
    static_configs:
      - targets:
          - 127.0.0.1:8080
        labels:
          instance: 178.103.224.86
          job: cadvisor
          server: docker
```

### 告警规则文件示例

> 在目录rules下，按服务分文件 \
> 规则参考 https://github.com/samber/awesome-prometheus-alerts \
> 后续可根据项目需要自定义规则和文案

```yaml
groups:
  - name: Node.rules
    rules:
      - alert: HostCpuUsage
        expr: (1-((sum(increase(node_cpu_seconds_total{mode="idle"}[5m])) by (instance))/ (sum(increase(node_cpu_seconds_total[5m])) by (instance))))*100 > 80
        for: 1m
        annotations:
          title: "CPU使用率过高"
          description: "主机: 【{{ $labels.instance }}】 5五分钟内CPU使用率超过80% (当前值：{{ $value }})"
        labels:
          severity: 'warning'

      - alert: HostMemoryUsage
        expr: (1-((node_memory_Buffers_bytes + node_memory_Cached_bytes + node_memory_MemFree_bytes)/node_memory_MemTotal_bytes))*100 > 80
        for: 1m
        annotations:
          title: "主机内存使用率超过80%"
          description: "主机: 【{{ $labels.instance }}】 内存使用率超过80% (当前使用率：{{ $value }}%)"
        labels:
          severity: 'warning'

      - alert: HostFileSystemUsage
        expr: (1-(node_filesystem_free_bytes{fstype=~"ext4|xfs",mountpoint!~".*tmp|.*boot" }/node_filesystem_size_bytes{fstype=~"ext4|xfs",mountpoint!~".*tmp|.*boot" }))*100 > 70
        for: 1m
        annotations:
          title: "磁盘空间剩余不足"
          description: "主机: 【{{ $labels.instance }}】 {{ $labels.mountpoint }}分区使用率超过70%, 当前值使用率：{{ $value }}%"
        labels:
          severity: 'warning'

      - alert: HostNetworkConnection-ESTABLISHED
        expr: sum(node_netstat_Tcp_CurrEstab) by (instance) > 1000
        for: 5m
        labels:
          severity: 'warning'
        annotations:
          title: "主机ESTABLISHED连接数过高"
          description: "主机: 【{{ $labels.instance }}】 ESTABLISHED连接数超过1000, 当前ESTABLISHED连接数: {{ $value }}"
```

#### Alertmanager配置文件

```yaml
global:
  resolve_timeout: 5m
  # email smtp
  smtp_from: 'xxx@qq.com'
  smtp_smarthost: 'smtp.qq.com:465'
  smtp_auth_username: 'xxx@qq.com'
  smtp_auth_password: 'xxx'
  smtp_require_tls: false

# 告警模板
templates:
  - 'tmpl/*.tmpl'

route:
  receiver: default-receiver            # 所有不匹配以下子路由的告警都将保留在根节点，并发送到“default-receiver”
  group_wait: 30s                       # 为一个组发送通知的初始等待时间，默认30s
  group_interval: 5m                    # 在发送新告警前的等待时间。通常5m或以上
  repeat_interval: 1h                   # 发送重复告警的周期。如果已经发送了通知，再次发送之前需要等待多长时间。
  group_by: [ 'alertname','server' ]    # 分组规则，如果满足group_by中包含的标签，则这些报警会合并为一个通知发给receiver

receivers: # 定义接收者，将告警发送给谁
  - name: 'default-receiver'
#    webhook_configs:
#      - url: 'https://xxx'
    email_configs:
      - to: 'xxx@qq.com'
        html: '{{ template "email.to.html" .}}'
        send_resolved: true
```

### 告警模版文件

> 以下为email模板 \
> 后续可根据项目需要自定义规则和文案

```text
{{ define "email.to.html" }}
{{- if gt (len .Alerts.Firing) 0 -}}
{{- range $index, $alert := .Alerts -}}
{{- if eq $index 0 -}}
=========告警通知==========<br>
告警类型: {{ .Labels.alertname }} <br>
告警级别: {{ .Labels.severity }} 级<br>
{{- end }}
----------------------------<br>
告警主题: {{ .Annotations.title }} <br>
故障详情: {{ .Annotations.description }} <br>
故障时间: {{ .StartsAt.Local }} <br>
{{ if gt (len .Labels.instance) 0 -}}故障主机: {{ .Labels.instance }} <br>{{- end -}}
=========请勿回复==========<br>
{{- end }}
{{- end }}

{{- if gt (len .Alerts.Resolved) 0 -}}
{{- range $index, $alert := .Alerts -}}
{{- if eq $index 0 -}}
==========告警恢复通知========<br>
告警类型: {{ .Labels.alertname }} <br>
告警级别: {{ .Labels.severity }} 级<br>
{{- end }}
----------------------------<br>
告警主题: {{ .Annotations.title }} <br>
触发详情: {{ .Annotations.description }}, 已恢复 <br>
故障时间: {{ .StartsAt.Local }} <br>
恢复时间: {{ .EndsAt.Local }} <br>
{{ if gt (len .Labels.instance) 0 -}}故障主机: {{ .Labels.instance }} <br>{{- end -}}
===========请勿回复===========<br>
{{- end }}
{{- end }}
{{- end }}

```